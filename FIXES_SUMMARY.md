# สรุปการแก้ไขระบบ Insurance Management System

## 1. แก้ไขระบบติดตามเงินผ่อนและติดตามการต่ออายุ
### เพิ่มตัวกรองเดือนและปี
- เพิ่มฟังก์ชัน `getInstallmentsByMonthYear()` และ `getRenewalsByMonthYear()` ใน code.gs
- สร้างไฟล์ tracking.js ที่มี UI สำหรับเลือกเดือน/ปี
- เพิ่มปุ่ม "ค้นหา" และ "เดือนปัจจุบัน" สำหรับการกรองข้อมูล
- รองรับการแสดงปี พ.ศ. ในตัวเลือก

### ไฟล์ที่แก้ไข:
- `code.gs`: เพิ่มฟังก์ชันกรองตามเดือน/ปี (บรรทัด 902-1007)
- `tracking.js`: สร้างไฟล์ใหม่สำหรับ UI ติดตามการผ่อนและต่ออายุ
- `index.html`: เพิ่ม script include สำหรับ tracking.js

## 2. แก้ไขระบบผ่อนชำระ
### ปัญหาที่แก้:
- ระบบไม่บันทึกแผนการผ่อนชำระเมื่อสร้างใบงาน

### การแก้ไข:
- แก้ไขฟังก์ชัน `saveWorkOrder()` ให้ใช้ข้อมูลจาก `installmentPlan` array ที่ส่งมาจาก frontend
- เปลี่ยนจาก `data.downPayment` และ `data.installmentDates` เป็น `data.installmentPlan`
- ใช้ `data.installmentPlan[0].amount` สำหรับเงินดาวน์
- ใช้ `data.installmentPlan.map(p => p.dueDate)` สำหรับวันครบกำหนด

## 3. แก้ไขเมนูประวัติการชำระเงิน
### ปัญหาที่แก้:
- ไม่แสดงข้อมูลแม้ว่ามีข้อมูลใน Sheet

### การแก้ไข:
- แก้ไขฟังก์ชัน `getPaymentHistory()` ให้แปลงข้อมูลเป็น String ก่อนเปรียบเทียบ
- เพิ่ม console.log สำหรับ debugging
- แปลงวันที่เป็นรูปแบบ ISO string ที่ถูกต้อง
- เพิ่ม default return value เป็น empty array

## โครงสร้างข้อมูลที่สำคัญ

### Sheet "ติดตามการผ่อนชำระ"
1. รหัสติดตาม (Tracking ID)
2. เลขที่ใบงาน
3. รหัสลูกค้า
4. ชื่อลูกค้า
5. งวดที่
6. จำนวนเงิน
7. วันครบกำหนด
8. สถานะ
9. วันที่ชำระ
10. หมายเหตุ
11. ผู้บันทึก

### Sheet "ติดตามการต่ออายุ"
1. รหัสติดตาม (Tracking ID)
2. เลขที่ใบงาน
3. รหัสลูกค้า
4. ชื่อลูกค้า
5. ประเภทประกัน
6. วันหมดอายุ
7. สถานะ (รอดำเนินการ/แจ้งผู้เอาประกันแล้ว/สั่งต่ออายุแล้ว/กรมธรรม์ขาดต่อ)
8. วันที่แจ้ง
9. วันที่สั่งต่อ
10. เลขกรมธรรม์ใหม่
11. หมายเหตุ
12. ผู้บันทึก

## ฟังก์ชันใหม่ที่เพิ่ม

### Backend (code.gs):
- `getInstallmentsByMonthYear(month, year)` - ดึงข้อมูลการผ่อนชำระตามเดือน/ปี
- `getRenewalsByMonthYear(month, year)` - ดึงข้อมูลการต่ออายุตามเดือน/ปี

### Frontend (tracking.js):
- `generateYearOptions()` - สร้างตัวเลือกปี
- `loadInstallmentTracking()` - โหลดหน้าติดตามการผ่อนชำระ
- `loadRenewalTracking()` - โหลดหน้าติดตามการต่ออายุ
- `filterInstallments()` - กรองข้อมูลการผ่อนชำระ
- `filterRenewals()` - กรองข้อมูลการต่ออายุ
- `loadCurrentMonthInstallments()` - โหลดข้อมูลผ่อนชำระเดือนปัจจุบัน
- `loadCurrentMonthRenewals()` - โหลดข้อมูลต่ออายุเดือนปัจจุบัน
- `displayInstallmentTracking()` - แสดงตารางติดตามการผ่อนชำระ
- `displayRenewalTracking()` - แสดงตารางติดตามการต่ออายุ
- `updateRenewalStatus()` - อัพเดตสถานะการต่ออายุ
- `saveRenewalStatus()` - บันทึกสถานะการต่ออายุ

## หมายเหตุ
- ระบบรองรับการแสดงปี พ.ศ. โดยอัตโนมัติ (ปี ค.ศ. + 543)
- การกรองข้อมูลทำงานแบบ real-time เมื่อกดปุ่มค้นหา
- มีปุ่ม "เดือนปัจจุบัน" สำหรับกลับมาดูข้อมูลเดือนปัจจุบันอย่างรวดเร็ว